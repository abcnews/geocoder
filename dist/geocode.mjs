import W from"minisearch";import v from"latlon-geohash";import{LRUMap as R}from"lru_map";import z from"metaphone";var N=function(r,t=0){let s=3735928559^t,n=1103547991^t;for(let a=0,f;a<r.length;a++)f=r.charCodeAt(a),s=Math.imul(s^f,2654435761),n=Math.imul(n^f,1597334677);return s=Math.imul(s^s>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(s^s>>>13,3266489909),4294967296*(2097151&n)+(s>>>0)},T=class extends Error{constructor(){super(),this.name="GeocodeAbortError"}},I=new URL("https://www.abc.net.au/res/sites/news-projects/geocoder/data/202208/"),k;async function U(){return k||(k=(async()=>{let t=await(await fetch(new URL("groups.json.gz",I).toString())).json();return new Set(t)})(),k)}var P=new Map,j=new WeakMap;async function L(r){let t=P.get(r);if(t)return t;let s=new AbortController;return t=(async()=>{let n=[],f=(await fetch(new URL(`${r}.txt.gz`,I).toString(),{signal:s.signal})).body?.getReader(),d=new TextDecoder("utf8"),l="",m=!1;for(;f&&!m;){let c=await f.read();m=c.done;let S=d.decode(c.value),o=l+S;l="";let p=o.split(`
`);for(let g=0;g<p.length;g++){let e=p[g];try{let i=JSON.parse(e);n.push(i)}catch(i){if(i instanceof SyntaxError&&g===p.length-1&&!m)l=e;else if(!(i instanceof SyntaxError&&!e))throw i}}}return n})(),P.set(r,t),j.set(t,s),t}function E(r){let t=P.get(r);if(t){let s=j.get(t);s&&s.abort(),P.delete(r)}}function O(r,t){return[r,...t.sort()].join(" ")}var C=new R(100);async function F(r,t,s){if(s){let d=new Set([...P.keys()]);for(let l of d)r.includes(l)&&d.delete(l);for(let l of d)E(l)}let n=[];for(let d of r){let l=O(d,t),m=C.get(l);m||(m=(async()=>{let c=[],S=await L(d);for(let o of S){let p=o.a.replace(/[^ -\w]/g,""),g=["","",[o.s,o.t,o.p].join(" ")];for(let e of o.b){g[1]=[e.l?"LOT ":"",e.m?e.n+"-"+e.m+" ":e.n+" ",o.a+" ",o.r?o.r:"",o.x?" "+o.x:""].join(""),g[0]=e.a??"";let i=g.filter(u=>!!u).join(", "),w=t.length===0||t.some(u=>u===e.n||u===e.m||u===o.p);if(w&&c.push({id:N(i),address:i,streetName:p,geohash:e.g,numericWords:e.m?[e.n,e.m,o.p]:[e.n,o.p]}),e.u&&t.length>0)for(let u in e.u){let y=e.u[u];u&&(u+=" ");for(let h of y)if(Array.isArray(h)&&h.length===2){for(let b=h[0];b<=h[1];b++)if(w||t.some(D=>D===b)){let D=u+b+", "+i;c.push({id:N(D),address:D,streetName:p,geohash:e.g,numericWords:e.m?[b,e.n,e.m,+o.p]:[b,e.n,+o.p]})}}else if(w||t.some(A=>A===h)){let A=u+h+", "+i;c.push({id:N(A),address:A,streetName:p,geohash:e.g,numericWords:e.m?[h,e.n,e.m,+o.p]:[h,e.n,+o.p]})}}}}return c})(),C.set(d,m)),n.push(m)}let a=new Map,f=await Promise.all(n);for(let d of f){for(let l of d)a.set(l.id,l);if(a.size>1e4)break}return Array.from(a.values())}var K=new Set(["NSW","VIC","QLD","WA","SA","TAS","ACT","NT"]),Z=r=>r.toUpperCase().replace(/(^|[^A-Z])(['A-Z]+)/g,(t,s,n)=>{let a=K.has(n)?n:n.substring(0,1)+n.substring(1).toLowerCase();return s+a}),G="",x,M=new R(100);async function B(r,t={}){let s=Date.now(),n=r.toUpperCase().replace(/[^-A-Z0-9\/,\. ]/g,"").replace(/[^A-Z0-9]+/g," ").trim(),a=M.get(n);if(a)return{input:r,results:a,startTime:s,duration:Date.now()-s};let f=n.split(" ").map(e=>isFinite(+e)?+e:e),d=[],l=[];f.forEach(e=>(typeof e=="number"||/\d/.test(e)?l:d).push(e));let m=new Set(l.map(e=>(typeof e=="number"?e:+e.replace(/[^\d]/g,""))%20)),c=new Set,S=await U();for(let e of d){let i=e.substring(0,1),w=z(e);if(m.size>0){let u=w.substring(0,2);for(let y of m){let h=[i,y,u].join("/");S.has(h)&&c.add(h)}}else{let u=w.substring(0,3),y=[i,"_",u].join("/");S.has(y)&&c.add(y)}}let o=[...Array.from(c.values()),...l].sort().join(" ");if(!x||G!==o){G=o;let e;try{e=await F(Array.from(c.values()),l,t.abortPrevious??!1)}catch(i){throw t.abortPrevious&&i instanceof DOMException&&i.name==="AbortError"?new T:i}x=new W({fields:["address","streetName"],storeFields:["address","geohash"]}),e&&x.documentCount===0&&x.addAll(e)}a=[];let p=x.search(r,{fuzzy:e=>/\d/.test(e)?!1:.333,prefix:e=>!/\d/.test(e),weights:{fuzzy:.25,prefix:.5},boost:{streetName:2},maxFuzzy:4}),g=p[0]?.score>0;for(let e of p){if(e.score===0&&g)break;let i=v.decode(e.geohash);if(a.push({address:Z(e.address),latitude:i.lat,longitude:i.lon,score:e.score,id:e.id}),a.length===t.limit)break}return M.set(n,a),{input:r,results:a,startTime:s,duration:Date.now()-s}}var $=B;export{T as GeocodeAbortError,$ as default,B as geocode};
