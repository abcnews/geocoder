"use strict";var F=Object.create;var k=Object.defineProperty;var K=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var B=Object.getPrototypeOf,J=Object.prototype.hasOwnProperty;var Q=(r,t)=>{for(var s in t)k(r,s,{get:t[s],enumerable:!0})},R=(r,t,s,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Z(t))!J.call(r,o)&&o!==s&&k(r,o,{get:()=>t[o],enumerable:!(n=K(t,o))||n.enumerable});return r};var C=(r,t,s)=>(s=r!=null?F(B(r)):{},R(t||!r||!r.__esModule?k(s,"default",{value:r,enumerable:!0}):s,r)),V=r=>R(k({},"__esModule",{value:!0}),r);var re={};Q(re,{GeocodeAbortError:()=>T,default:()=>te,geocode:()=>O});module.exports=V(re);var v=C(require("minisearch")),z=C(require("latlon-geohash")),M=require("lru_map"),U=C(require("metaphone")),G=function(r,t=0){let s=3735928559^t,n=1103547991^t;for(let o=0,f;o<r.length;o++)f=r.charCodeAt(o),s=Math.imul(s^f,2654435761),n=Math.imul(n^f,1597334677);return s=Math.imul(s^s>>>16,2246822507)^Math.imul(n^n>>>13,3266489909),n=Math.imul(n^n>>>16,2246822507)^Math.imul(s^s>>>13,3266489909),4294967296*(2097151&n)+(s>>>0)},T=class extends Error{constructor(){super(),this.name="GeocodeAbortError"}},L=new URL("https://www.abc.net.au/res/sites/news-projects/geocoder/data/202208/"),N;async function _(){return N||(N=(async()=>{let t=await(await fetch(new URL("groups.json.gz",L).toString())).json();return new Set(t)})(),N)}var P=new Map,E=new WeakMap;async function $(r){let t=P.get(r);if(t)return t;let s=new AbortController;return t=(async()=>{let n=[],f=(await fetch(new URL(`${r}.txt.gz`,L).toString(),{signal:s.signal})).body?.getReader(),d=new TextDecoder("utf8"),l="",m=!1;for(;f&&!m;){let c=await f.read();m=c.done;let S=d.decode(c.value),i=l+S;l="";let p=i.split(`
`);for(let g=0;g<p.length;g++){let e=p[g];try{let a=JSON.parse(e);n.push(a)}catch(a){if(a instanceof SyntaxError&&g===p.length-1&&!m)l=e;else if(!(a instanceof SyntaxError&&!e))throw a}}}return n})(),P.set(r,t),E.set(t,s),t}function q(r){let t=P.get(r);if(t){let s=E.get(t);s&&s.abort(),P.delete(r)}}function H(r,t){return[r,...t.sort()].join(" ")}var I=new M.LRUMap(100);async function X(r,t,s){if(s){let d=new Set([...P.keys()]);for(let l of d)r.includes(l)&&d.delete(l);for(let l of d)q(l)}let n=[];for(let d of r){let l=H(d,t),m=I.get(l);m||(m=(async()=>{let c=[],S=await $(d);for(let i of S){let p=i.a.replace(/[^ -\w]/g,""),g=["","",[i.s,i.t,i.p].join(" ")];for(let e of i.b){g[1]=[e.l?"LOT ":"",e.m?e.n+"-"+e.m+" ":e.n+" ",i.a+" ",i.r?i.r:"",i.x?" "+i.x:""].join(""),g[0]=e.a??"";let a=g.filter(u=>!!u).join(", "),w=t.length===0||t.some(u=>u===e.n||u===e.m||u===i.p);if(w&&c.push({id:G(a),address:a,streetName:p,geohash:e.g,numericWords:e.m?[e.n,e.m,i.p]:[e.n,i.p]}),e.u&&t.length>0)for(let u in e.u){let y=e.u[u];u&&(u+=" ");for(let h of y)if(Array.isArray(h)&&h.length===2){for(let b=h[0];b<=h[1];b++)if(w||t.some(D=>D===b)){let D=u+b+", "+a;c.push({id:G(D),address:D,streetName:p,geohash:e.g,numericWords:e.m?[b,e.n,e.m,+i.p]:[b,e.n,+i.p]})}}else if(w||t.some(A=>A===h)){let A=u+h+", "+a;c.push({id:G(A),address:A,streetName:p,geohash:e.g,numericWords:e.m?[h,e.n,e.m,+i.p]:[h,e.n,+i.p]})}}}}return c})(),I.set(d,m)),n.push(m)}let o=new Map,f=await Promise.all(n);for(let d of f){for(let l of d)o.set(l.id,l);if(o.size>1e4)break}return Array.from(o.values())}var Y=new Set(["NSW","VIC","QLD","WA","SA","TAS","ACT","NT"]),ee=r=>r.toUpperCase().replace(/(^|[^A-Z])(['A-Z]+)/g,(t,s,n)=>{let o=Y.has(n)?n:n.substring(0,1)+n.substring(1).toLowerCase();return s+o}),j="",x,W=new M.LRUMap(100);async function O(r,t={}){let s=Date.now(),n=r.toUpperCase().replace(/[^-A-Z0-9\/,\. ]/g,"").replace(/[^A-Z0-9]+/g," ").trim(),o=W.get(n);if(o)return{input:r,results:o,startTime:s,duration:Date.now()-s};let f=n.split(" ").map(e=>isFinite(+e)?+e:e),d=[],l=[];f.forEach(e=>(typeof e=="number"||/\d/.test(e)?l:d).push(e));let m=new Set(l.map(e=>(typeof e=="number"?e:+e.replace(/[^\d]/g,""))%20)),c=new Set,S=await _();for(let e of d){let a=e.substring(0,1),w=(0,U.default)(e);if(m.size>0){let u=w.substring(0,2);for(let y of m){let h=[a,y,u].join("/");S.has(h)&&c.add(h)}}else{let u=w.substring(0,3),y=[a,"_",u].join("/");S.has(y)&&c.add(y)}}let i=[...Array.from(c.values()),...l].sort().join(" ");if(!x||j!==i){j=i;let e;try{e=await X(Array.from(c.values()),l,t.abortPrevious??!1)}catch(a){throw t.abortPrevious&&a instanceof DOMException&&a.name==="AbortError"?new T:a}x=new v.default({fields:["address","streetName"],storeFields:["address","geohash"]}),e&&x.documentCount===0&&x.addAll(e)}o=[];let p=x.search(r,{fuzzy:e=>/\d/.test(e)?!1:.333,prefix:e=>!/\d/.test(e),weights:{fuzzy:.25,prefix:.5},boost:{streetName:2},maxFuzzy:4}),g=p[0]?.score>0;for(let e of p){if(e.score===0&&g)break;let a=z.default.decode(e.geohash);if(o.push({address:ee(e.address),latitude:a.lat,longitude:a.lon,score:e.score,id:e.id}),o.length===t.limit)break}return W.set(n,o),{input:r,results:o,startTime:s,duration:Date.now()-s}}var te=O;0&&(module.exports={GeocodeAbortError,geocode});
